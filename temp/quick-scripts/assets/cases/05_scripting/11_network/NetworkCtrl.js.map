{"version":3,"sources":["NetworkCtrl.js"],"names":["i18n","require","cc","Class","extends","Component","properties","xhr","Label","xhrAB","xhrTimeout","websocket","socketIO","xhrResp","xhrABResp","xhrTimeoutResp","websocketResp","socketIOResp","onLoad","_wsiSendBinary","string","t","sendXHR","sendXHRAB","sendXHRTimeout","prepareWebSocket","sendSocketIO","loader","getXMLHttpRequest","streamXHREventsToLabel","open","sys","isNative","setRequestHeader","timeout","send","Uint8Array","XMLHttpRequest","self","websocketLabel","respLabel","WebSocket","binaryType","onopen","evt","onmessage","binary","Uint16Array","data","binaryStr","str","i","length","hexChar","toString","toUpperCase","String","fromCharCode","onerror","onclose","scheduleOnce","sendWebSocketBinary","sender","readyState","OPEN","buf","arrData","charCodeAt","buffer","warningStr","testevent","msg","tag","message","disconnection","io","error","sioclient","connect","_sioClient","on","bind","log","eventLabel","label","method","responseHandler","handler","response","substring","eventLabelOrigin","forEach","eventname","onreadystatechange","status","responseText"],"mappings":"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","file":"NetworkCtrl.js","sourceRoot":"../../../../../../assets/cases/05_scripting/11_network","sourcesContent":["const i18n = require('i18n');\n\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        xhr: cc.Label,\n        xhrAB: cc.Label,\n        xhrTimeout: cc.Label,\n        websocket: cc.Label,\n        socketIO: cc.Label,\n        \n        xhrResp: cc.Label,\n        xhrABResp: cc.Label,\n        xhrTimeoutResp: cc.Label,\n        websocketResp: cc.Label,\n        socketIOResp: cc.Label\n    },\n\n    // use this for initialization\n    onLoad: function () {\n        this._wsiSendBinary = null;\n        \n        this.xhrResp.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.1\");\n        this.xhrABResp.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.2\");\n        this.xhrTimeoutResp.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.2\");\n        this.websocketResp.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.3\");\n        this.socketIOResp.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.4\");\n        \n        this.sendXHR();\n        this.sendXHRAB();\n        this.sendXHRTimeout();\n        this.prepareWebSocket();\n        this.sendSocketIO();\n    },\n    \n    sendXHR: function () {\n        var xhr = cc.loader.getXMLHttpRequest();\n        this.streamXHREventsToLabel(xhr, this.xhr, this.xhrResp, 'GET');\n\n        xhr.open(\"GET\", \"https://httpbin.org/get?show_env=1\", true);\n        if (cc.sys.isNative) {\n            xhr.setRequestHeader(\"Accept-Encoding\",\"gzip,deflate\");\n        }\n\n        // note: In Internet Explorer, the timeout property may be set only after calling the open()\n        // method and before calling the send() method.\n        xhr.timeout = 5000;// 5 seconds for timeout\n\n        xhr.send();\n    },\n    \n    sendXHRAB: function () {\n        var xhr = cc.loader.getXMLHttpRequest();\n        this.streamXHREventsToLabel(xhr, this.xhrAB, this.xhrABResp, \"POST\");\n\n        xhr.open(\"POST\", \"https://httpbin.org/post\");\n        //set Content-type \"text/plain\" to post ArrayBuffer or ArrayBufferView\n        xhr.setRequestHeader(\"Content-Type\",\"text/plain\");\n        // Uint8Array is an ArrayBufferView\n        xhr.send(new Uint8Array([1,2,3,4,5]));\n    },\n    \n    sendXHRTimeout: function () {\n        var xhr = new XMLHttpRequest();\n        this.streamXHREventsToLabel(xhr, this.xhrTimeout, this.xhrTimeoutResp, 'GET');\n\n        xhr.open(\"GET\", \"https://192.168.22.222\", true);\n\n        // note: In Internet Explorer, the timeout property may be set only after calling the open()\n        // method and before calling the send() method.\n        xhr.timeout = 5000;// 5 seconds for timeout\n        xhr.send();\n    },\n    \n    prepareWebSocket: function () {\n        var self = this;\n        var websocketLabel = this.websocket;\n        var respLabel = this.websocketResp;\n        this._wsiSendBinary = new WebSocket(\"ws://echo.websocket.org\");\n        this._wsiSendBinary.binaryType = \"arraybuffer\";\n        this._wsiSendBinary.onopen = function(evt) {\n            websocketLabel.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.5\");\n        };\n\n        this._wsiSendBinary.onmessage = function(evt) {\n            var binary = new Uint16Array(evt.data);\n            var binaryStr = 'response bin msg: ';\n\n            var str = '';\n            for (var i = 0; i < binary.length; i++) {\n                if (binary[i] === 0)\n                {\n                    str += \"\\'\\\\0\\'\";\n                }\n                else\n                {\n                    var hexChar = '0x' + binary[i].toString('16').toUpperCase();\n                    str += String.fromCharCode(hexChar);\n                }\n            }\n\n            binaryStr += str;\n            respLabel.string = binaryStr;\n            websocketLabel.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.6\");\n        };\n\n        this._wsiSendBinary.onerror = function(evt) {\n            websocketLabel.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.7\");\n        };\n\n        this._wsiSendBinary.onclose = function(evt) {\n            websocketLabel.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.8\");\n            // After close, it's no longer possible to use it again, \n            // if you want to send another request, you need to create a new websocket instance\n            self._wsiSendBinary = null;\n        };\n        \n        this.scheduleOnce(this.sendWebSocketBinary, 1);\n    },\n\n    sendWebSocketBinary: function(sender)\n    {\n        if (!this._wsiSendBinary) { return; }\n        if (this._wsiSendBinary.readyState === WebSocket.OPEN)\n        {\n            this.websocket.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.9\");\n            var buf = \"Hello WebSocket中文,\\0 I'm\\0 a\\0 binary\\0 message\\0.\";\n            \n            var arrData = new Uint16Array(buf.length);\n            for (var i = 0; i < buf.length; i++) {\n                arrData[i] = buf.charCodeAt(i);\n            }\n            \n            this._wsiSendBinary.send(arrData.buffer);\n        }\n        else\n        {\n            var warningStr = \"send binary websocket instance wasn't ready...\";\n            this.websocket.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.10\") + warningStr;\n            this.scheduleOnce(function () {\n                this.sendWebSocketBinary();\n            }, 1);\n        }\n    },\n\n    // Socket IO callbacks for testing\n    testevent: function(data) {\n        if (!this.socketIO) { return; }\n\n        var msg = this.tag + \" says 'testevent' with data: \" + data;\n        this.socketIO.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.11\") + msg;\n    },\n\n    message: function(data) {\n        if (!this.socketIO) { return; }\n\n        var msg = this.tag + \" received message: \" + data;\n        this.socketIOResp.string = msg;\n    },\n\n    disconnection: function() {\n        if (!this.socketIO) { return; }\n\n        var msg = this.tag + \" disconnected!\";\n        this.socketIO.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.12\") + msg;\n    },\n    \n    sendSocketIO: function () {\n        var self = this;\n        if (typeof io === 'undefined') {\n            cc.error('You should import the socket.io.js as a plugin!');\n            return;\n        }\n        //create a client by using this static method, url does not need to contain the protocol\n        var sioclient = io.connect(\"ws://tools.itharbors.com:4000\", {\"force new connection\" : true});\n        this._sioClient = sioclient;\n\n        //if you need to track multiple sockets it is best to store them with tags in your own array for now\n        this.tag = sioclient.tag = \"Test Client\";\n        \n        //register event callbacks\n        //this is an example of a handler declared inline\n        sioclient.on(\"connect\", function() {\n            if (!self.socketIO) { return; }\n\n            var msg = sioclient.tag + \" Connected!\";\n            self.socketIO.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.13\") + msg;\n\n            // Send message after connection\n            self._sioClient.send(\"Hello Socket.IO!\");\n        });\n\n        //example of a handler that is shared between multiple clients\n        sioclient.on(\"message\", this.message.bind(this));\n\n        sioclient.on(\"echotest\", function (data) {\n            if (!self.socketIO) { return; }\n\n            cc.log(\"echotest 'on' callback fired!\");\n            var msg = self.tag + \" says 'echotest' with data: \" + data;\n            self.socketIO.string = i18n.t(\"cases/05_scripting/11_network/NetworkCtrl.js.14\") + msg;\n        });\n\n        sioclient.on(\"testevent\", this.testevent.bind(this));\n\n        sioclient.on(\"disconnect\", this.disconnection.bind(this));\n    },\n    \n    streamXHREventsToLabel: function ( xhr, eventLabel, label, method, responseHandler ) {\n        var handler = responseHandler || function (response) {\n            return method + \" Response (30 chars): \" + response.substring(0, 30) + \"...\";\n        };\n        \n        var eventLabelOrigin = eventLabel.string;\n        // Simple events\n        ['loadstart', 'abort', 'error', 'load', 'loadend', 'timeout'].forEach(function (eventname) {\n            xhr[\"on\" + eventname] = function () {\n                eventLabel.string = eventLabelOrigin + \"\\nEvent : \" + eventname;\n            };\n        });\n    \n        // Special event\n        xhr.onreadystatechange = function () {\n            if (xhr.readyState === 4 && (xhr.status >= 200 && xhr.status < 300)) {\n                label.string = handler(xhr.responseText);\n            }\n        };\n    }\n});\n"]}